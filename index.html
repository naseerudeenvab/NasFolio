<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    html, body {
      background: #fff;
      margin: 0;
      padding: 0;
      width: 100vw;
      min-height: 100vh;
      box-sizing: border-box;
    }
    .container {
      padding-top: 10px;
      padding-left: 0;
      padding-right: 0;
      margin-left: 0;
      margin-right: 0;
      width: 100vw;
      max-width: 100vw;
    }
    .card { margin-bottom: 16px; }
    .buy-row { background-color: #e6ffe6; }
    .sell-row { background-color: #ffe6e6; }
    .script-profit { color: #198754; font-weight: bold; }
    .script-loss { color: #dc3545; font-weight: bold; }
    .logo-header {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-bottom: 16px;
      text-align: center;
    }
    .logo-header img {
      max-width: 90vw;
      max-height: 80px;
      width: auto;
      height: auto;
      margin-bottom: 2px;
    }
    .form-control, .btn, .nav-link, .card-header h5, .card-header .mb-0 {
      font-size: 1.1rem;
    }
    .btn, .form-control {
      min-height: 44px;
    }
    .autocomplete-suggestion {
      font-size: 1.05rem;
    }
    .table-responsive { width: 100%; overflow-x: auto; }
    @media (max-width: 900px) {
      .card-header h5, .card-header .mb-0 { font-size: 1rem; }
      .nav-link { font-size: 1rem; }
    }
    @media (max-width: 600px) {
      .container {
        padding-left: 0 !important;
        padding-right: 0 !important;
        margin-left: 0 !important;
        margin-right: 0 !important;
        width: 100vw !important;
        max-width: 100vw !important;
      }
      .logo-header h1 { font-size: 1.1rem; }
      .logo-header img { max-height: 48px; }
      .card-header h5, .card-header .mb-0 { font-size: 0.98rem; }
      .nav-link { font-size: 0.98rem; }
      .col-md-4, .col-md-3, .col-md-2 { flex: 0 0 100%; max-width: 100%; }
      .row.g-2 > [class^='col-'] { margin-bottom: 8px; }
      .form-control, .btn { font-size: 1.08rem; min-height: 44px; }
      .autocomplete-suggestion { font-size: 1.08rem; }
      .container { padding-left: 2px; padding-right: 2px; }
    }
    .autocomplete-suggestions {
      position: absolute;
      background: #fff;
      border: 1px solid #ccc;
      z-index: 1000;
      width: 100%;
      max-height: 180px;
      overflow-y: auto;
    }
    .autocomplete-suggestion {
      padding: 6px 12px;
      cursor: pointer;
    }
    .autocomplete-suggestion:hover {
      background: #f0f0f0;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo-header">
      <img src="https://raw.githubusercontent.com/naseerudeenvab/NasFolio/main/nasfolio.png" alt="NasFolio Trading Analysis" id="logo-img">
    </div>
    <ul class="nav nav-tabs mt-2" id="mainTab" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="stock-tab" data-bs-toggle="tab" data-bs-target="#stockTabPane" type="button" role="tab" aria-controls="stockTabPane" aria-selected="true">Stock Search</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="allstocks-tab" data-bs-toggle="tab" data-bs-target="#allStocksTabPane" type="button" role="tab" aria-controls="allStocksTabPane" aria-selected="false">All Stocks</button>
      </li>
    </ul>
    <div class="tab-content" id="mainTabContent">
      <!-- Stock Search Tab -->
      <div class="tab-pane fade show active" id="stockTabPane" role="tabpanel" aria-labelledby="stock-tab">
        <div class="card mt-3">
          <div class="card-header">
            <h5>Stock Search</h5>
          </div>
          <div class="card-body">
            <form onsubmit="searchStock(); return false;">
              <div class="row g-2 mb-3 position-relative flex-column flex-md-row">
                <div class="col-md-4 col-12 position-relative mb-2 mb-md-0">
                  <input type="text" id="symbolInput" class="form-control" placeholder="Enter stock symbol" autocomplete="off" oninput="showSuggestions()">
                  <div id="symbolSuggestions" class="autocomplete-suggestions" style="display:none;"></div>
                </div>
                <div class="col-md-3 col-12 mb-2 mb-md-0">
                  <input type="date" id="startDateInput" class="form-control" placeholder="Start date">
                </div>
                <div class="col-md-3 col-12 mb-2 mb-md-0">
                  <input type="date" id="endDateInput" class="form-control" placeholder="End date">
                </div>
                <div class="col-md-2 col-12">
                  <button class="btn btn-primary w-100" type="submit">Search</button>
                </div>
              </div>
            </form>
            <div class="table-responsive"><div id="stockResult"></div></div>
          </div>
        </div>
      </div>
      <!-- All Stocks Tab -->
      <div class="tab-pane fade" id="allStocksTabPane" role="tabpanel" aria-labelledby="allstocks-tab">
        <div class="card mt-3">
          <div class="card-header d-flex align-items-center justify-content-between flex-wrap">
            <h5 class="mb-0">All Traded Scripts (Profit/Loss)</h5>
            <div class="mt-2 mt-md-0">
              <label for="sortSelect" class="me-2">Sort by:</label>
              <select id="sortSelect" class="form-select d-inline-block w-auto" onchange="loadAllScripts()">
                <option value="order">Data order</option>
                <option value="alpha">Alphabetically</option>
                <option value="pnl">Profit/Loss order</option>
              </select>
              <button class="btn btn-outline-secondary btn-sm ms-2" onclick="loadAllScripts()">Refresh</button>
            </div>
          </div>
          <div class="card-body">
            <div class="table-responsive"><div id="allScriptsResult"></div></div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script>
    let allSymbols = [];
    function fetchAllSymbols() {
      google.script.run.withSuccessHandler(function(symbols) {
        allSymbols = symbols;
      }).withFailureHandler(showError).getAllSymbols();
    }
    function showSuggestions() {
      const input = document.getElementById('symbolInput');
      const val = input.value.trim().toUpperCase();
      const suggBox = document.getElementById('symbolSuggestions');
      if (val.length < 3 || !allSymbols.length) {
        suggBox.style.display = 'none';
        return;
      }
      const matches = allSymbols.filter(s => s.startsWith(val));
      if (!matches.length) {
        suggBox.style.display = 'none';
        return;
      }
      suggBox.innerHTML = matches.map(s => `<div class='autocomplete-suggestion' onclick='selectSuggestion("${s}")'>${s}</div>`).join('');
      suggBox.style.display = 'block';
    }
    function selectSuggestion(symbol) {
      document.getElementById('symbolInput').value = symbol;
      document.getElementById('symbolSuggestions').style.display = 'none';
    }
    document.addEventListener('click', function(e) {
      if (!e.target.classList.contains('autocomplete-suggestion')) {
        document.getElementById('symbolSuggestions').style.display = 'none';
      }
    });
    function searchStock() {
      const symbol = document.getElementById('symbolInput').value;
      let startDate = document.getElementById('startDateInput').value;
      let endDate = document.getElementById('endDateInput').value;
      if (!symbol) return;
      // Convert yyyy-mm-dd to dd-mm-yyyy for backend
      if (startDate) {
        const [y, m, d] = startDate.split('-');
        startDate = `${d}-${m}-${y}`;
      }
      if (endDate) {
        const [y, m, d] = endDate.split('-');
        endDate = `${d}-${m}-${y}`;
      }
      google.script.run
        .withSuccessHandler(displayStockResult)
        .withFailureHandler(showError)
        .searchStock(symbol, startDate, endDate);
    }
    function displayStockResult(result) {
      let html = `
        <div class="alert alert-info">
          <h6>Summary for ${result.symbol}</h6>
          <p>Total Trades: ${result.totalTrades}</p>
          <p>Net Position: ${result.netPosition}</p>
          <p>Net P&L: ₹${result.netValue.toFixed(2)}</p>
        </div>
        <table class="table table-sm">
          <thead>
            <tr>
              <th>Date</th>
              <th>Type</th>
              <th>Quantity</th>
              <th>Price</th>
            </tr>
          </thead>
          <tbody>
      `;
      result.trades.forEach(trade => {
        const rowClass = trade.type.toLowerCase() === 'buy' ? 'buy-row' : 'sell-row';
        html += `
          <tr class="${rowClass}">
            <td>${trade.date}</td>
            <td>${trade.type}</td>
            <td>${trade.quantity}</td>
            <td>₹${trade.price}</td>
          </tr>
        `;
      });
      html += '</tbody></table>';
      document.getElementById('stockResult').innerHTML = html;
    }
    function loadAllScripts() {
      const sortBy = document.getElementById('sortSelect').value;
      google.script.run
        .withSuccessHandler(displayAllScripts)
        .withFailureHandler(showError)
        .listAllScripts(sortBy);
    }
    function displayAllScripts(scripts) {
      if (!scripts || scripts.length === 0) {
        document.getElementById('allScriptsResult').innerHTML = '<div class="text-muted">No scripts found.</div>';
        return;
      }
      let html = '<div class="row">';
      scripts.forEach(s => {
        const colorClass = s.pnl >= 0 ? 'script-profit' : 'script-loss';
        html += `<div class="col-md-2 col-4 col-6 col-sm-3 mb-2"><span class="${colorClass}">${s.symbol}</span></div>`;
      });
      html += '</div>';
      document.getElementById('allScriptsResult').innerHTML = html;
    }
    function showError(error) {
      alert('Error: ' + error.message);
    }
    // Auto-load all scripts when All Stocks tab is shown
    document.getElementById('allstocks-tab').addEventListener('click', loadAllScripts);
    // Fetch all symbols for autocomplete on page load
    window.onload = fetchAllSymbols;
  </script>
</body>
</html>
